import type { SvelteHTMLElements } from 'svelte/elements';
import sharp from 'sharp';

const CURRENT_FACIAL_HAIR = 'mustache';

export const DEFAULT_COLORS = {
	shirt: '#113056',
	accent: '#174672',
	hair: '#96713a',
	background: '#a9ba86',
	skin: '#f6d4a8',
	skinShadow: '#efbd85'
};

export type FacialHairStyle = 'shaved' | 'mustache' | 'beard';

export type AvatarProps = SvelteHTMLElements['svg'] & {
	format?: 'svg' | 'png';
	uint8?: boolean;
	facialHair?: FacialHairStyle;
	colors?: Partial<typeof DEFAULT_COLORS>;
	circle?: boolean;
};

export default async function Avatar({
	format = 'svg',
	uint8 = false,
	...props
}: AvatarProps = {}) {
	const svgString = getSvgString(props);

	if (format === 'svg') {
		if (uint8) {
			return Buffer.from(svgString);
		}

		return svgString;
	}

	if (format === 'png') {
		const png = await sharp(Buffer.from(svgString)).png();

		if (uint8) {
			const pngBuffer = await png.toBuffer();
			return pngBuffer;
		}

		return png;
	}
}

function getFacialHair(style: FacialHairStyle, color: string) {
	switch (style) {
		case 'mustache':
			return `
        <path
          class="avatar-mustache"
          d="M281.305,270.613c-3.41,5.17-9.34.79-13.32.32-3.95-.48-10.9-.62-17.82-.49-6.93-.13-13.87.01-17.82.49-3.99.47-9.91,4.85-13.32-.32-1.15-1.75,3.68-17.11,5.4-18.35,3.4-2.44,19.32-2.1,24.06-2.1.56,0,1.12.01,1.68.02.56-.01,1.12-.02,1.68-.02,4.74,0,20.66-.34,24.05,2.1,1.73,1.24,6.56,16.6,5.41,18.35Z"
          fill="${color}"
        />`;
		case 'beard':
			return `
        <path
          class="avatar-beard"
          d="M337.154,188.123h-7.622c-.094,6.36-.354,12.606-.646,18.633-.104,2.263-.907,10.281-1.168,11.845-.626,3.67-.511,6.892-1.647,10.615-2.513,8.29-12.7,23.836-21.647,25.651-5.641,1.147-10.281-1.689-15.609-3.013-12.221-3.024-25.932-3.691-38.497-3.67-11.897.021-24.441.719-36.036,3.378-7.362,1.679-14.066,6.194-21.355,1.585-11.751-7.435-17.09-25.39-20.562-37.996-2.461-8.936-2.815-18.028-1.783-27.027h-6.6c.542,16.381,1.804,32.772,3.754,49.049,2.304,32.115,14.514,63.334,46.046,76.326.177.209.365.417.573.594.198.167.407.334.636.427,19.009,7.654,49.018,8.175,68.35,1.439.24-.083.448-.24.667-.396.209-.167.407-.365.594-.563,31.156-11.053,41.896-36.338,46.797-66.817l.803-5.568c.917-7.977,1.272-16.11,1.23-24.201.803-9.603,3.921-29.749,3.723-30.291ZM267.908,277.66c-9.478,5.568-26.912,5.537-36.359-.073-1.554-.918-5.266-3.066-2.575-4.828l41.854.083c2.377,1.804-1.387,3.921-2.92,4.817Z"
          fill="${color}"
        />`;
		default:
			return '';
	}
}

function getSvgString({ format, facialHair, colors, circle, ...rest }: AvatarProps = {}) {
	const _facialHair = facialHair ?? CURRENT_FACIAL_HAIR;
	const _colors = { ...DEFAULT_COLORS, ...colors };

	const svgProps = Object.entries(rest)
		.map(([key, value]) => `${key}="${value}"`)
		.join(' ');

	return `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" ${svgProps}>
      <g class="avatar" clip-path="${circle ? 'circle() view-box' : ''}">
        <rect class="avatar-background" width="500" height="500" fill="${_colors.background}" />
        <g class="avatar-head">
          <g class="avatar-skin">
            <path
              d="M249.625,245.433l.5-.31-.23.5c-.09.01-.18.01-.27.01v-.2Z"
              fill="${_colors.skinShadow}"
            />
            <path
              d="M348.685,222.993c-.61,8.26-8.08,14.84-16.27,14.87-.03,16.23-7.39,31.47-17.16,44-8.43,10.82-19.1,20.06-30.74,27.29-.12,8.91-.27,17.86-.12,26.77l-.29.47c-23.41-2.4-46.82-4.8-70.24-7.2l-.26-.53c-.04-6.91.03-13.84,0-20.76l1.17.14c10.4,6.18,21.82,11.61,34.14,12.1l1.21.52v-75.54h-19.51c.96-4.98,2.43-9.9,3.88-14.76,4.25-14.29,9.37-28.38,15.61-41.91l.02-50.13c1.16-.5,2.35-.97,3.58-1.27,20.84-5.05,41.56-10.42,62.07-16.69.17-.05.83.08.92.19,6.6,8.4,9.96,24.7,11.35,35.24l8.87,33.05c6.11,1.49,11.24,7.62,11.77,13.87.45,5.38.4,14.88,0,20.28Z"
              fill="${_colors.skinShadow}"
            />
            <path
              d="M240.535,135.723c-3.9,2.1-7.96,3.89-12.08,5.51,6.87-.69,13.73-1.7,20.56-3.03l1.11.12-.02,50.13c-6.24,13.53-11.36,27.62-15.61,41.91-1.45,4.86-2.92,9.78-3.88,14.76h19.51l-.5.31v.2c.09,0,.18,0,.27-.01l.23-.5v75.54l-1.21-.52c-12.32-.49-23.74-5.92-34.14-12.1l-1.17-.14c-19.28-12.31-39.19-34.63-44.24-57.43-.93-4.21-1.25-8.31-1.57-12.57-6.67-.4-12.68-4.19-15.09-10.54-1.73-4.57-1.5-18.34-1.14-23.65.48-6.94,5.23-13.54,12.27-14.87l21.56-45.87c3.09-5.32,6.24-7.75,12.26-9.49,16.76-4.84,33.3-7.49,50.5-10.12.31-.04.64-.01.97.02.34.03.67.1,1,.18.81.7.73,2.87,0,3.75.2.08.45.26.39.42-.91,2.33-7.92,6.88-9.98,7.99Z"
              fill="${_colors.skin}"
            />
            <path
              d="M248.915,320.143l1.21.52c-10.23-.02-20.52-3.95-29.43-8.71-2.33-1.25-4.87-2.63-7.09-4.05l1.17.14c10.4,6.18,21.82,11.61,34.14,12.1Z"
              fill="${_colors.skin}"
            />
            <path d="M249.895,245.623c-.09.01-.18.01-.27.01v-.2l.5-.31-.23.5Z" fill="${_colors.skin}" />
            <path
              d="M284.392,335.918c.016.915-.345,2.349.5,2.751-3.384,2.656-7.706,6.986-10.762,10.123-7.353,7.55-14.026,15.844-21.376,23.397-.553.568-2.258,2.482-2.741,2.761-1.466.844-2.232-.184-3.147-1.132-11.277-11.686-21.992-23.954-33.26-35.65-.013-3.165.017-6.34,0-9.505l70.785,7.254Z"
              fill="${_colors.skin}"
            />
            <path
              d="M250.125,123.562c.163-.026,2.261-.866,2.255-.372-.522,1.445-.86,3.24-2.255,4.123.178-1.108-.127-2.589,0-3.752Z"
              fill="${_colors.skinShadow}"
            />
          </g>
          ${getFacialHair(_facialHair, _colors.hair)}
          <path
            class="avatar-hair"
            d="M163.832,188.844c-2.198-26.819-6.847-56.217,5.658-81.26,13.908-27.852,44.617-36.45,73.745-37.561,27.479-1.048,61.709,2.704,79.916,25.66,18.655,23.522,17.634,64.845,13.767,93.161-1.245,9.118-3.123,18.141-4.252,27.265-.206.211-3.804-.674-3.967-1.161-.264-.787-.094-6.453-.045-7.73.776-20.214,1.381-40.465-2.607-60.404-1.787-8.935-4.523-18.317-9.642-25.893l-.557-.072c-21.675,6.23-43.61,12.917-65.723,17.47-5.551,1.143-11.293,2.229-16.915,2.97-2.581.34-5.252.59-7.85.657,6.555-2.673,13.362-5.222,19.194-9.323,1.164-.818,5.382-4.133,5.571-5.31.616-1.186,1.14-2.407,1.571-3.665-.73.304-1.253.275-1.571-.087-16.921,2.693-37.055,5.415-53.218,10.689-7.291,2.379-9.066,5.303-12.695,11.817-9.571,17.18-17.556,45.947-13,65.29.906,3.85-.019-.253.777,3.591l-5.994,1.161"
            fill="${_colors.hair}"
          />
        </g>
        <g class="avatar-shirt">
          <path
            class="avatar-collar"
            d="M316.405,350.173l-.69.05-42.46,50.46-23.89-24.66c-.73-.2-1.31.33-1.78.81-4.46,4.58-8.91,9.38-13.25,14.14,0,0-1.66,1.9-1.89,1.96l-7.44,7.81c-13.93-16.98-27.81-34.12-41.64-51.43l-.52.11c.51-.16,1.17-.61,1.81-.82,9.76-3.16,19.53-6.36,28.95-10.43l1.71,1.29c10.97,11.57,21.86,23.16,32.66,34.77.66.69,1.38.69,2.05.07,6.48-6.77,12.94-13.85,19.4-21.24,4.73-5.08,9.38-9.96,14.58-14.32l.89-.07c.16-.13.33-.23.49-.36,7.17,2.41,14.08,5.93,21.21,8.55,3.19,1.17,6.62,2.29,9.81,3.31Z"
            fill="${_colors.accent}"
          />
          <path
            class="avatar-shirt-base"
            d="M427.215,500H73.035c2.72-28.76,9.68-56.79,15.44-84.99,3.55-17.41,2.52-27.48,18.6-38.43,19.79-13.46,52.68-19.76,75.77-27.16l.52-.11c13.83,17.31,27.71,34.45,41.64,51.43l10.37-10.91.15-.16c3.96-4.33,8-8.68,12.06-12.84.47-.48,1.05-1.01,1.78-.81l23.89,24.66,42.46-50.46.69-.05c23.01,7.34,57.24,13.63,76.62,27.31,15.42,10.89,14.42,22.11,18.01,39.02,5.88,27.72,13.13,55.23,16.18,83.5Z"
            fill="${_colors.shirt}"
          />
          <path
            class="avatar-pocket-square"
            d="M344.672,437.969v49.275l-23.557,8.582-1.081.192c-8.323-2.57-16.39-5.965-24.637-8.775v-48.899l.375-.375h48.899Z"
            fill="${_colors.accent}"
          />
          <rect
            class="avatar-seam"
            x="231.865"
            y="383.526"
            width="1.787"
            height="116.477"
            fill="${_colors.accent}"
          />
          <circle class="button" cx="249.058" cy="405.246" r="3.855" fill="${_colors.accent}" />
          <circle class="button" cx="249.058" cy="445.753" r="3.855" fill="${_colors.accent}" />
          <circle class="button" cx="249.058" cy="486.259" r="3.855" fill="${_colors.accent}" />
        </g>
      </g>
    </svg>
  `;
}
